
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Measurement - synthetic control method (SCM) &#8212; A gentle introduction to personalization for everyone</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Landing page" href="landing-page.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">A gentle introduction to personalization for everyone</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="landing-page.html">
   Landing page
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Measurement - synthetic control method (SCM)
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/Measurement - synthetic control.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/Measurement - synthetic control.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Measurement - synthetic control method (SCM)
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-scm">
     What is SCM
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#when-to-use-scm">
       When to use SCM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#strengths-of-scm">
       Strengths of SCM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#challenges-with-scm">
       Challenges with SCM
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#california-proposition-99">
     California proposition 99
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#clean-data-for-downstream-work">
   Clean data for downstream work
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implement-scm">
   Implement SCM
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#outliers">
   Outliers
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recalculate-california-synthetic-control-after-removing-noise">
   Recalculate california synthetic control after removing noise
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#confidence-intervals">
   Confidence Intervals
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#confidence-intervals-using-the-t-distribution">
     Confidence Intervals Using the t Distribution
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#confidence-intervals-using-the-normal-distribution">
     Confidence Intervals Using the Normal Distribution
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#placebo-state">
   Placebo state
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#treated-california-sales-go-down-by-25-0-mean-lift-with-ci-30-7-19-4-in-comparison-montana-untreated-placebo-sales-go-up-around-7-3-with-ci-3-6-10-9-therefore-scm-measure-signifies-that-the-treatment-was-meaningful">
     Treated California sales go down by 25.0% (mean lift) with CI [-30.7%,-19.4%]. In comparison, Montana untreated, placebo sales go up around 7.3%, with CI [3.6%, 10.9%]. Therefore, SCM measure signifies that the treatment was meaningful.
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="measurement-synthetic-control-method-scm">
<h1>Measurement - synthetic control method (SCM)<a class="headerlink" href="#measurement-synthetic-control-method-scm" title="Permalink to this headline">¶</a></h1>
<div class="section" id="what-is-scm">
<h2>What is SCM<a class="headerlink" href="#what-is-scm" title="Permalink to this headline">¶</a></h2>
<p>SCM is a quasi-experimental design to do causal inference, similar to diff-in-diff (DID).</p>
<p>In the situation where the random selection is not feasible, or there might be spillovers between treatments and control, quasi-experiments are used to measure the impact of the treatments.</p>
<p>The challenge with DID method is that it requires similar covariates between the treated and control groups, which is not always feasible.
Another problem is that if the frowth trend from the treatment is different from the trend of the control, DID will be biased, a common problem with non-random data.</p>
<p>To work around with this, we use what is known as synthetic control method to measure the treatment outcome against a look-alike generated control population.
SCM generates control set by providing formal criteria and explains the relative importance of each donor by employing linear models.
What is more, the choice of synthetic control does not rely on post-intervention outcomes, making it impossible to cherry-pick the study design that may affect the conclusions.</p>
<div class="section" id="when-to-use-scm">
<h3>When to use SCM<a class="headerlink" href="#when-to-use-scm" title="Permalink to this headline">¶</a></h3>
<p>SCM is best method when the experiment takes place at aggregate level, eg. country, state, county, and there are only a handful of control and test cases. Due to these charateristics, SCM is the go-to method for large-scale program evaluation.</p>
</div>
<div class="section" id="strengths-of-scm">
<h3>Strengths of SCM<a class="headerlink" href="#strengths-of-scm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>First and foremost, SCM generated counterfactual is almost the same the treated case.</p></li>
<li><p>Secondly, SCM is easy to explain since it mostly employing linear models. You can explain the weights of each covariates by using the weights of the model.</p></li>
</ul>
</div>
<div class="section" id="challenges-with-scm">
<h3>Challenges with SCM<a class="headerlink" href="#challenges-with-scm" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>By design, SCM works at aggregate level, not individual level.</p></li>
<li><p>Also, it requires a relatively long pre-treatment period so that it could model good counterfactual data.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="california-proposition-99">
<h2>California proposition 99<a class="headerlink" href="#california-proposition-99" title="Permalink to this headline">¶</a></h2>
<p>To see it in action, let’s consider the problem of estimating the effect of cigarette taxation on its consumption.</p>
<p>In 1988, California passed a famous Tobacco Tax and Health Protection Act, which became known as Proposition 99.</p>
<p>“Its primary effect is to impose a 25-cent per pack state excise tax on the sale of tobacco cigarettes within California, with approximately equivalent excise taxes similarly imposed on the retail sale of other commercial tobacco products, such as cigars and chewing tobacco. Additional restrictions placed on the sale of tobacco include a ban on cigarette vending machines in public areas accessible by juveniles and a ban on the individual sale of single cigarettes. Revenue generated by the act was earmarked for various environmental and health care programs, and anti-tobacco advertisements.”</p>
<p>To evaluate its effect, we can gather data on cigarette sales from multiple states and across a number of years. In our case, we got data from the years 1970 to 2000 from 39 states. Other states had similar Tobacco control programs and were dropped from the analysis. Here is what our data looks like.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Download data from online source, and store locally</span>
<span class="c1"># df = pd.read_csv(&#39;https://raw.githubusercontent.com/synth-inference/synthdid/master/data/california_prop99.csv&#39;,</span>
<span class="c1">#                 sep = &#39;;&#39;)</span>
<span class="c1"># df.to_csv(&#39;data/california_prop99.csv&#39;)</span>

<span class="n">df</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/california_prop99.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>State</th>
      <th>Year</th>
      <th>PacksPerCapita</th>
      <th>treated</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Alabama</td>
      <td>1970</td>
      <td>89.800003</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>Arkansas</td>
      <td>1970</td>
      <td>100.300003</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>Colorado</td>
      <td>1970</td>
      <td>124.800003</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Connecticut</td>
      <td>1970</td>
      <td>120.000000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>Delaware</td>
      <td>1970</td>
      <td>155.000000</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># style plots</span>
<span class="k">def</span> <span class="nf">write_local_style</span><span class="p">():</span>
    <span class="n">mpltxt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;patch.linewidth: 0.5</span><span class="se">\n</span><span class="s2">patch.facecolor: 348ABD  </span><span class="se">\n</span><span class="s2">patch.edgecolor: EEEEEE</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    patch.antialiased: True</span><span class="se">\n</span><span class="s2">lines.solid_capstyle: round</span><span class="se">\n</span><span class="s2">font.size: 10.0</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    font.family: Trebuchet MS</span><span class="se">\n</span><span class="s2">text.color: 575757</span><span class="se">\n</span><span class="s2">axes.facecolor: none</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    axes.edgecolor: 575757</span><span class="se">\n</span><span class="s2">axes.spines.left   : True   </span><span class="se">\n</span><span class="s2">axes.spines.bottom : True</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    axes.spines.top    : False</span><span class="se">\n</span><span class="s2">axes.spines.right  : False</span><span class="se">\n</span><span class="s2">axes.linewidth: 1</span><span class="se">\n</span><span class="s2">axes.grid: True</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    axes.titlesize: x-large</span><span class="se">\n</span><span class="s2">axes.labelsize: large</span><span class="se">\n</span><span class="s2">axes.labelcolor: 575757</span><span class="se">\n</span><span class="s2">axes.axisbelow: True       </span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    axes.prop_cycle: cycler(&#39;color&#39;, [&#39;29ba74&#39;, &#39;6e6f73&#39;, &#39;295e7e&#39;, &#39;670f31&#39;, &#39;98b21c&#39;, &#39;9a9a9a&#39;, &#39;3ead92&#39;])</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    xtick.color: 575757</span><span class="se">\n</span><span class="s2">xtick.direction: out</span><span class="se">\n</span><span class="s2">xtick.labelsize : medium</span><span class="se">\n</span><span class="s2">xtick.major.width: 1</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    xtick.major.size: 4      </span><span class="se">\n</span><span class="s2">ytick.color: 575757</span><span class="se">\n</span><span class="s2">ytick.direction: out</span><span class="se">\n</span><span class="s2">ytick.labelsize : medium</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    ytick.major.width: 1</span><span class="se">\n</span><span class="s2">ytick.major.size: 4</span><span class="se">\n</span><span class="s2">grid.color: none</span><span class="se">\n</span><span class="s2">figure.facecolor: none</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">    figure.edgecolor: 0.50</span><span class="se">\n</span><span class="s2">figure.dpi: 150      </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/style/mystyle.mplstyle&#39;</span><span class="p">,</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mpltxt</span><span class="p">)</span>

<span class="n">write_local_style</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;data/style/mystyle.mplstyle&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">2773</span><span class="n">c532c10c</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># style plots</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="k">def</span> <span class="nf">write_local_style</span><span class="p">():</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;matplotlib&#39;
</pre></div>
</div>
</div>
</div>
<p>Here the plot shows the difference between California pre and post vs other states average pre and post.</p>
<p>A few observations from the plot:</p>
<ul class="simple">
<li><p>Apparently people in California bought fewer cigarettes than national average.</p></li>
<li><p>There is a downwards trending in both California and other states of the country</p></li>
<li><p>It seems like the decreasing trend in California were accelerated after the proposition 99, but we can’t say it for sure.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">california</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;California&#39;</span><span class="p">,</span> <span class="s1">&#39;Calfornia&#39;</span><span class="p">,</span> <span class="s2">&quot;National average&quot;</span><span class="p">))</span>\
<span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span><span class="s1">&#39;california&#39;</span><span class="p">])[</span><span class="s1">&#39;PacksPerCapita&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
<span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span> <span class="s1">&#39;california&#39;</span><span class="p">,</span> <span class="s1">&#39;PacksPerCapita&#39;</span><span class="p">)</span>\
<span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">lw</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
          <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
          <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Proposition 99&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales Trend&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Per-capita cigarette sales (in packs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_8_0.png" src="_images/Measurement - synthetic control_8_0.png" />
</div>
</div>
<p>To answer the question whether Proposition 99 had an effect on cigarette consumption, we will use the pre-intervention period to build a synthetic control, which means we will build a fake state that resembles very closely the trend of California.</p>
</div>
</div>
<div class="section" id="clean-data-for-downstream-work">
<h1>Clean data for downstream work<a class="headerlink" href="#clean-data-for-downstream-work" title="Permalink to this headline">¶</a></h1>
<p>Ideally we want to see the data with each state as columns, and dates as rows, so that we can use any machine learning model to use other states as variables and we represent the outcome as a weighted average of the units (i.e. a dot product of the each state PacksPerCapita and regression weight).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span>   <span class="c1"># filter pre-intervention period</span>
<span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;Year&#39;</span><span class="p">)[</span><span class="s1">&#39;PacksPerCapita&#39;</span><span class="p">]</span>
<span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># flip the table to have one column per state</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inverted</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>State</th>
      <th>Alabama</th>
      <th>Arkansas</th>
      <th>California</th>
      <th>Colorado</th>
      <th>...</th>
      <th>Virginia</th>
      <th>West Virginia</th>
      <th>Wisconsin</th>
      <th>Wyoming</th>
    </tr>
    <tr>
      <th>Year</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1970</th>
      <td>89.800003</td>
      <td>100.300003</td>
      <td>123.000000</td>
      <td>124.800003</td>
      <td>...</td>
      <td>124.300003</td>
      <td>114.500000</td>
      <td>106.400002</td>
      <td>132.199997</td>
    </tr>
    <tr>
      <th>1971</th>
      <td>95.400002</td>
      <td>104.099998</td>
      <td>121.000000</td>
      <td>125.500000</td>
      <td>...</td>
      <td>128.399994</td>
      <td>111.500000</td>
      <td>105.400002</td>
      <td>131.699997</td>
    </tr>
    <tr>
      <th>1972</th>
      <td>101.099998</td>
      <td>103.900002</td>
      <td>123.500000</td>
      <td>134.300003</td>
      <td>...</td>
      <td>137.000000</td>
      <td>117.500000</td>
      <td>108.800003</td>
      <td>140.000000</td>
    </tr>
    <tr>
      <th>1973</th>
      <td>102.900002</td>
      <td>108.000000</td>
      <td>124.400002</td>
      <td>137.899994</td>
      <td>...</td>
      <td>143.100006</td>
      <td>116.599998</td>
      <td>109.500000</td>
      <td>141.199997</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>108.199997</td>
      <td>109.699997</td>
      <td>126.699997</td>
      <td>132.800003</td>
      <td>...</td>
      <td>149.600006</td>
      <td>119.900002</td>
      <td>111.800003</td>
      <td>145.800003</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 39 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="implement-scm">
<h1>Implement SCM<a class="headerlink" href="#implement-scm" title="Permalink to this headline">¶</a></h1>
<p>Here we will try to build a fake unit that resemble the treated unit</p>
<p>To do this with linear regression, we will find the weights of each state that can be rebuild to the new fake state.</p>
<p>For modeling, we run a regulated regression such as Lasso, Ridge or ElasticNet because we don’t want the model to overfit. The regression will return as a set of weights that minimize the square difference between the treated unit and the units in the other states.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">ElasticNet</span><span class="p">,</span> <span class="n">Ridge</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># training data would be before 1989 when the state of California introduced the Act</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">inverted</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">1988</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_synthetic_control</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">inverted</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;California&#39;</span><span class="p">):</span>
    <span class="c1"># other states </span>
    <span class="n">other_states</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">state</span><span class="p">]</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="c1"># state of california</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">other_states</span><span class="p">]</span> <span class="c1"># other states</span>

    <span class="n">weights_regression</span> <span class="o">=</span> <span class="n">ElasticNet</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;State&#39;</span><span class="p">:</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> 
                                   <span class="s1">&#39;weights&#39;</span><span class="p">:</span><span class="n">weights_regression</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)})</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;State weights : &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weights</span><span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;weights&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Forming the synthetic control</span>
    <span class="n">synth_control</span> <span class="o">=</span> <span class="n">inverted</span><span class="p">[</span><span class="n">other_states</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights_regression</span><span class="p">)</span>
    
    <span class="n">cal</span> <span class="o">=</span> <span class="n">inverted</span><span class="p">[[</span><span class="n">state</span><span class="p">]]</span>
    <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;synth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synth_control</span>
    <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">-</span> <span class="n">synth_control</span>
    <span class="k">return</span> <span class="n">cal</span><span class="p">,</span> <span class="n">weights</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">state_pools</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span>
<span class="n">cal</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">create_synthetic_control</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">inverted</span><span class="p">,</span> <span class="n">state_pools</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;California&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State weights : 
            State  weights
2        Colorado    0.283
19         Nevada    0.217
3     Connecticut    0.132
7        Illinois    0.044
17        Montana    0.042
6           Idaho    0.039
20  New Hampshire    0.038
9            Iowa    0.028
37        Wyoming    0.003
</pre></div>
</div>
</div>
</div>
<p>Now we have the synthetic control, we can plot it with the outcome variable of the state of California</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_actual_synth</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;California&#39;</span><span class="p">):</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">state</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;synth&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Synthetic Control&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales Trend&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gap in per-capita cigarette sales (in packs)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_actual_synth</span><span class="p">(</span><span class="n">cal</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;California&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_20_0.png" src="_images/Measurement - synthetic control_20_0.png" />
</div>
</div>
</div>
<div class="section" id="outliers">
<h1>Outliers<a class="headerlink" href="#outliers" title="Permalink to this headline">¶</a></h1>
<p>Here we premute the treated and control exhaustively. Since we only have one treated unit, this means that for each unit, we pretend it is the treated while the others are the control.</p>
<p>in the end, we will have one synthetic control and effect estimates for each state. What this does is it pretends that the treatment actually happened for another state, not California, and see what would have been the estimated .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">synthetic_control</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">1988</span><span class="p">]</span>
    <span class="n">use_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_gap&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">state</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># treated state</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">use_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># other states</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">Lasso</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span>

    <span class="n">synth</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">use_cols</span><span class="p">]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="n">state</span> <span class="o">+</span> <span class="s1">&#39;_gap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">-</span> <span class="n">synth</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outlier_data</span> <span class="o">=</span> <span class="n">inverted</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">outlier_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">outlier_data</span> <span class="o">=</span> <span class="n">synthetic_control</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">outlier_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From the plot, 2 things jumped out:</p>
<ol class="simple">
<li><p>the variance after the intervention is higher than the variance before intervention. This is expected since the synthetic control is designed to minimize the difference in the pre-intervention period.</p></li>
<li><p>There are some states we can’t fit very well even in the pre-intervention period. This is also to be expected, since these might be outliers.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outlier_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_gap&#39;</span><span class="p">)]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">outlier_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">outlier_data</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Gap in per-capita cigarette sales (in packs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Before removing outliers&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_25_0.png" src="_images/Measurement - synthetic control_25_0.png" />
</div>
</div>
<p>Since the states are pooly fit, we would remove those outliers from our analysis.</p>
<p>One way to do this is to make a cut with the mean squared error pre intervention.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here we remove the outliers that are over a certain percentile </span>

<span class="k">def</span> <span class="nf">identify_outliers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">outlier_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="mi">1988</span><span class="p">]</span>
    <span class="n">gap_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">train_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_gap&#39;</span><span class="p">)]</span>
    <span class="n">traim_mse</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">gap_cols</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">traim_mse</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="s1">&#39;mse&#39;</span><span class="p">]</span>
    <span class="n">traim_mse</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;State&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_gap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">traim_mse</span><span class="o">.</span><span class="n">boxplot</span><span class="p">()</span>
    
    <span class="n">upper_percentile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">traim_mse</span><span class="o">.</span><span class="n">mse</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">percentile</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Upper percentile of mse is </span><span class="si">{</span><span class="n">upper_percentile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">outliers</span> <span class="o">=</span> <span class="n">traim_mse</span><span class="p">[(</span><span class="n">traim_mse</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">upper_percentile</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing outliers:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">traim_mse</span><span class="p">[(</span><span class="n">traim_mse</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">]</span><span class="o">&lt;=</span> <span class="n">upper_percentile</span><span class="p">)][</span><span class="s1">&#39;State&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_outlier_state</span><span class="o">=</span> <span class="n">identify_outliers</span><span class="p">(</span><span class="n">outlier_data</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Upper percentile of mse is 5.3694883758656555
removing outliers:
             State        mse
3      Connecticut   5.474684
9             Iowa  13.679449
10          Kansas   5.440212
14       Minnesota   5.992962
15     Mississippi   8.916232
20   New Hampshire  14.930626
21      New Mexico  19.287343
28  South Carolina   7.034796
34        Virginia   7.545174
38      California   9.950632
</pre></div>
</div>
<img alt="_images/Measurement - synthetic control_28_1.png" src="_images/Measurement - synthetic control_28_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">non_outlier_state</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">outlier_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">outlier_data</span><span class="p">[</span><span class="n">state</span> <span class="o">+</span> <span class="s1">&#39;_gap&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Gap in per-capita cigarette sales (in packs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;After removing outliers&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_29_0.png" src="_images/Measurement - synthetic control_29_0.png" />
</div>
</div>
</div>
<div class="section" id="recalculate-california-synthetic-control-after-removing-noise">
<h1>Recalculate california synthetic control after removing noise<a class="headerlink" href="#recalculate-california-synthetic-control-after-removing-noise" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the non outlier states as new pool</span>
<span class="n">cal_non_outlier</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">create_synthetic_control</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">inverted</span><span class="p">,</span> <span class="n">non_outlier_state</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;California&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State weights : 
       State  weights
2   Colorado    0.320
14    Nevada    0.241
6   Illinois    0.130
3   Delaware    0.050
5      Idaho    0.043
12   Montana    0.036
28   Wyoming    0.004
13  Nebraska    0.002
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New plot without outliers as control</span>
<span class="n">print_actual_synth</span><span class="p">(</span><span class="n">cal_non_outlier</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;California&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_33_0.png" src="_images/Measurement - synthetic control_33_0.png" />
</div>
</div>
</div>
<div class="section" id="confidence-intervals">
<h1>Confidence Intervals<a class="headerlink" href="#confidence-intervals" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span> <span class="o">=</span> <span class="n">cal_non_outlier</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1990</span><span class="p">:]</span>
<span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;lift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;synth&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;lift&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Sample mean</span>
<span class="n">x_bar</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">x_bar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.25021991433494045
</pre></div>
</div>
</div>
</div>
<div class="section" id="confidence-intervals-using-the-t-distribution">
<h2>Confidence Intervals Using the t Distribution<a class="headerlink" href="#confidence-intervals-using-the-t-distribution" title="Permalink to this headline">¶</a></h2>
<p>If we’re working with a small sample (n &lt;30), we can use the t.interval() function from the scipy.stats library to calculate a confidence interval for a population mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean_confidence_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="c1"># Mean and standard error</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">se</span> <span class="o">*</span> <span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">confidence</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># t distribution margin of error</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">m</span><span class="o">+</span><span class="n">h</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_confidence_interval</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.25021991433494045, -0.30690450934438895, -0.19353531932549195)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or simply use one line of code here</span>
<span class="n">st</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.30690450934438895, -0.19353531932549195)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Another way to calculate CI using t distribution</span>
<span class="kn">import</span> <span class="nn">statsmodels.stats.api</span> <span class="k">as</span> <span class="nn">sms</span>

<span class="n">sms</span><span class="o">.</span><span class="n">DescrStatsW</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">tconfint_mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.3069045093443889, -0.1935353193254919)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="confidence-intervals-using-the-normal-distribution">
<h2>Confidence Intervals Using the Normal Distribution<a class="headerlink" href="#confidence-intervals-using-the-normal-distribution" title="Permalink to this headline">¶</a></h2>
<p>If we’re working with larger samples (n≥30), we can assume that the sampling distribution of the sample mean is normally distributed (thanks to the Central Limit Theorem) and can instead use the norm.interval() function from the scipy.stats library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#create 95% confidence interval for population mean weight</span>
<span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-0.30008205133721116, -0.20035777733266974)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="placebo-state">
<h1>Placebo state<a class="headerlink" href="#placebo-state" title="Permalink to this headline">¶</a></h1>
<p>SCM does not offer standard errors, which makes it harder to get the significance of performance outcome. One way to evaluate this is to perform a placebo test.</p>
<p>Placebo tests are more commonly used in medical experiments. During a drug experiment, patients who are administrated drugs tend to show a positive recovery as they believe that the new drug will recover them. This psychological effect also impact the outcome of the experiment. To avoid this, placebos were introduced. Hence the actual impact of the drug will be measured as the difference between the treatment with and without placebo.</p>
<p>This practice can be used measure the effectiveness of the SCM as well. The treatment state is replaced with one or many of the control state and synthetic control is generated for this control state. This will prove that there is no identifiable effect on the control from the treatment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find the state that has the highest corr with California pre 1989 </span>
<span class="n">train_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()[</span><span class="s1">&#39;California&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State
California       1.000000
New Hampshire    0.957438
Nevada           0.932807
Montana          0.930455
Colorado         0.926956
Name: California, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Montana has similar scale of sales compare to California</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">inverted</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inverted</span><span class="p">[</span><span class="s1">&#39;California&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">inverted</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inverted</span><span class="p">[</span><span class="s1">&#39;Montana&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Montana&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales Trend&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gap in per-capita cigarette sales (in packs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_47_0.png" src="_images/Measurement - synthetic control_47_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_outlier_state_MO</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">non_outlier_state</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;Montana&#39;</span><span class="p">]</span>

<span class="c1"># Use the non outlier states as new pool</span>
<span class="n">mon_non_outlier</span><span class="p">,</span> <span class="n">mon_weights</span> <span class="o">=</span> <span class="n">create_synthetic_control</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">inverted</span><span class="p">,</span> 
                                                        <span class="n">non_outlier_state_MO</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;Montana&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State weights : 
             State  weights
2         Colorado    0.472
5            Idaho    0.160
15    North Dakota    0.128
27         Wyoming    0.084
25   West Virginia    0.024
13          Nevada    0.023
6         Illinois    0.016
14  North Carolina    0.016
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mon_weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>State      AlabamaArkansasColoradoDelawareGeorgiaIdahoIll...
weights                                                0.923
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># New plot without outliers as control</span>
<span class="n">print_actual_synth</span><span class="p">(</span><span class="n">mon_non_outlier</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;Montana&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/Measurement - synthetic control_50_0.png" src="_images/Measurement - synthetic control_50_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mon_non_outlier</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>State</th>
      <th>Montana</th>
      <th>synth</th>
      <th>gap</th>
    </tr>
    <tr>
      <th>Year</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1996</th>
      <td>87.300003</td>
      <td>78.873669</td>
      <td>8.426334</td>
    </tr>
    <tr>
      <th>1997</th>
      <td>88.900002</td>
      <td>77.564091</td>
      <td>11.335911</td>
    </tr>
    <tr>
      <th>1998</th>
      <td>89.099998</td>
      <td>78.027461</td>
      <td>11.072538</td>
    </tr>
    <tr>
      <th>1999</th>
      <td>82.599998</td>
      <td>75.909695</td>
      <td>6.690304</td>
    </tr>
    <tr>
      <th>2000</th>
      <td>75.500000</td>
      <td>69.552599</td>
      <td>5.947401</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span> <span class="o">=</span> <span class="n">mon_non_outlier</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1990</span><span class="p">:]</span>
<span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;lift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;synth&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">&#39;lift&#39;</span><span class="p">]</span>
<span class="n">mean_confidence_interval</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.07250751767040958, 0.036094979268137733, 0.10892005607268143)
</pre></div>
</div>
</div>
</div>
<div class="section" id="treated-california-sales-go-down-by-25-0-mean-lift-with-ci-30-7-19-4-in-comparison-montana-untreated-placebo-sales-go-up-around-7-3-with-ci-3-6-10-9-therefore-scm-measure-signifies-that-the-treatment-was-meaningful">
<h2>Treated California sales go down by 25.0% (mean lift) with CI [-30.7%,-19.4%]. In comparison, Montana untreated, placebo sales go up around 7.3%, with CI [3.6%, 10.9%]. Therefore, SCM measure signifies that the treatment was meaningful.<a class="headerlink" href="#treated-california-sales-go-down-by-25-0-mean-lift-with-ci-30-7-19-4-in-comparison-montana-untreated-placebo-sales-go-up-around-7-3-with-ci-3-6-10-9-therefore-scm-measure-signifies-that-the-treatment-was-meaningful" title="Permalink to this headline">¶</a></h2>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="landing-page.html" title="previous page">Landing page</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Richuang Lin<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>